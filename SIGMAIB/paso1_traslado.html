<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Solicitud de Traslado | SIGMA-IB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header>
    <img src="img/logo_imss.png" alt="IMSS" />
    <div class="titulo-centro">
      Sistema Integral de Gestión Médica y Ambulancias<br />
      <small><strong>(SIGMA-IB)</strong></small>
    </div>
    <img src="img/Sigma-ib.png" alt="SIGMA" />
  </header>

  <h1>Formato de Solicitud de Traslado Interhospitalario</h1>
  <h2><u>Sección 1: Información de la Unidad Solicitante</u></h2>

  <main style="max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">

    <form id="formPaso1">
      <input type="hidden" name="formulario_origen" value="Traslado" />
      <input type="hidden" id="fecha_hora_envio" name="fecha_hora_envio" />

      <label>Código de Traslado</label>
      <input type="text" id="codigo_traslado" name="codigo_traslado" readonly required>

      <label>Fecha de Solicitud</label>
      <input type="date" id="fecha_solicitud" name="fecha_solicitud" required>

      <label>Hora de Solicitud</label>
      <input type="time" id="hora_solicitud" name="hora_solicitud" required>

      <label>Unidad Médica Solicitante</label>
      <input type="text" id="unidad_medica" name="unidad_medica" readonly>

      <label>Turno</label>
      <select id="turno" name="turno" required>
        <option value="">Seleccione...</option>
        <option>Matutino</option>
        <option>Vespertino</option>
        <option>Nocturno</option>
      </select>

      <label>Servicio Solicitante</label>
      <select id="servicio" name="servicio" required>
        <option value="">Seleccione...</option>
        <option>Urgencias</option>
        <option>Medicina Interna</option>
        <option>Pediatría</option>
        <option>Ginecología</option>
        <option>Cirugía</option>
        <option>Trauma y Ortopedia</option>
        <option>Terapia Intensiva </option>
      </select>

      <label>Número de Cama</label>
      <input type="number" id="cama" name="cama" required>

      <label>Prioridad</label>
      <select id="prioridad" name="prioridad" required>
        <option value="">Seleccione...</option>
        <option>Rojo</option>
        <option>Amarillo</option>
        <option>Baja</option>
      </select>

      <label>Motivo Clínico del Traslado</label>
      <textarea name="motivo_traslado" rows="2"></textarea>

      <label>Médico Solicitante</label>
      <input type="text" name="medico_solicitante">

      <label>Médico que Entrega</label>
      <input type="text" name="medico_entrega">

      <label>Diagnóstico Principal</label>
      <textarea name="diagnostico" rows="2"></textarea>

      <label>Familiar Responsable</label>
      <input type="text" name="familiar_responsable">

      <label>Teléfono del Responsable</label>
      <input type="tel" id="contacto_responsable" name="contacto_responsable" pattern="[0-9]{10}" maxlength="10" required>

      <label>Fecha de Ingreso</label>
      <input type="date" name="fecha_ingreso">

      <button type="button" onclick="guardarPaso1()">Guardar y continuar</button>
    </form>
  </main>

  <script>
    window.onload = () => {
      const nombreVisible = localStorage.getItem("nombre_visible") || "SIN UNIDAD";
      const codigo = generarCodigoTraslado();
      const hoy = new Date();
      const fechaHoy = hoy.toISOString().split("T")[0];
      const horaHoy = hoy.toTimeString().substring(0, 5);
  
      document.getElementById("codigo_traslado").value = codigo;
      document.getElementById("fecha_solicitud").value = fechaHoy;
      document.getElementById("hora_solicitud").value = horaHoy;
      document.getElementById("unidad_medica").value = nombreVisible;
      document.getElementById("fecha_hora_envio").value = new Date().toLocaleString();
    };
  
    function generarCodigoTraslado() {
      const fecha = new Date();
      const dia = String(fecha.getDate()).padStart(2, '0');
      const mes = String(fecha.getMonth() + 1).padStart(2, '0');
      const año = fecha.getFullYear().toString().slice(2);
      const aleatorio = Math.random().toString(36).substring(2, 5).toUpperCase();
      return `TRS-${año}${mes}${dia}-${aleatorio}`;
    }
  
    function guardarPaso1() {
      const form = document.getElementById("formPaso1");
      const formData = new FormData(form);
  
      fetch("https://script.google.com/macros/s/AKfycbzFn969rKf6A_e8t-oRc2clUvHAWwZkWKuZk58K8Mien-qb0ZArdqHwjxknMKyQ1pbJBQ/exec", {
  method: "POST",
  body: new URLSearchParams(formData)
})

      .then(res => res.text())
      .then(data => {
        if (data.trim() === "OK") {
          alert("Formulario enviado correctamente.");
          const codigo = document.getElementById("codigo_traslado").value;
          localStorage.setItem("codigo_traslado", codigo);
          window.location.href = "paso2_paciente.html"; // Redirecciona
        } else {
          alert("Error del servidor: " + data);
        }
      })
      .catch(err => {
        alert("Error de conexión: " + err.message);
      });
    }
  </script>